<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Vibe Event Planner'Z - Professional event management system">
  <meta name="theme-color" content="#667eea">
  
  <!-- PWA Meta Tags -->
  <link rel="manifest" href="/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Vibe Events">
  
  <!-- Icons for different platforms -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/icon-120x120.png">
  
  <title>Vibe Event Planner'Z - Login</title>

  <!-- INSTANT AUTH CHECK - Redirect if already logged in (no login page flash) -->
  <script>
    (function() {
      if (localStorage.getItem('isAuthenticated') === 'true') {
        window.location.replace('/calendar.html');
      }
    })();
  </script>

  <!-- INSTANT THEME LOADER - Prevent flash of default theme -->
  <script>
    (function() {
      try {
        const stored = localStorage.getItem('VIBE_THEME_CONFIG');
        if (stored) {
          const config = JSON.parse(stored);
          // Store in document for CSS to use
          document.documentElement.setAttribute('data-active-theme', config.theme);
          document.documentElement.setAttribute('data-theme-mode', config.mode);
          console.log('[InstantLoader] Theme loaded from localStorage:', config.theme);
        }
      } catch (e) {
        console.warn('[InstantLoader] Error loading theme:', e);
      }
    })();
  </script>

  <!-- Firebase Scripts (MUST be before firebase-config.js) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
  <script src="/firebase-config.js"></script>

  <!-- Festival Theme Engine (AFTER Firebase) -->
  <script src="/themes/_core/theme-engine.js"></script>

  <script src="https://accounts.google.com/gsi/client" async defer onload="initGoogle()"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #768bec 0%, #7407e0 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .login-container {
      max-width: 450px;
      width: 100%;
      position: relative;
      z-index: 10;
    }
    
    .login-card {
      /* Translucent background */
      /* background: hsl( 27, 10%, 90%, 0.5); */
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px); /*For Safari support */
      background: linear-gradient(to top,#8f26e6 0%, #000 100%);
      border-radius: 24px;
      padding: 48px 40px;
      /* box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); */
      box-shadow: inset 0 0 1px 1px hsl(204, 100%, 90%, 1),
                  10px 10px 60px 20px hsl(194, 100%, 9%, 0.5);
      transform: translateY(0);
      transition: all 0.3s ease;
    }
    
    .login-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.4);
    }
    
    .logo-container {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .logo {
      width: 100px;
      height: 100px;
      /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
      /* border-radius: 50%; */
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      /* Glow effect */
      filter: drop-shadow(0 0 15px rgba(255, 170, 60, 0.6))
              drop-shadow(0 0 30px rgba(255, 120, 0, 0.4));
      /* font-size: 36px; */
      animation: pulse 3s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1.05); }
      50% { transform: scale(1.4); }
    }
    
    h1 {
      font-size: 36px;
      font-weight: bold;
      font-family: playfair display, serif;
      background: linear-gradient(135deg, #f0a925 10%, #ec300f 90%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }
    
    .subtitle {
      color: #e2e2e2;
      font-size: 14px;
    }
    
    .features {
      margin: 32px 0;
    }
    
    .feature {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      color: #f0f0f0;
      font-size: 14px;
    }
    
    .feature-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #ffffffb4 0%, #96939920 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    /* Manual credentials form */
    .manual-login {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 12px;
    }

    .manual-login input {
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid #e6e6e6;
      font-size: 14px;
      width: 100%;
    }

    .manual-signin-btn {
      padding: 12px 14px;
      border-radius: 10px;
      border: none;
      background: #667eea;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }

    .google-signbtn {
      text-align: center;
      align-items: center;
      justify-content: center;  
    }
    
    .google-signin {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .google-signin:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    .google-signin:active {
      transform: translateY(0);
    }

    /* Custom Google Sign-In Button Styling */
    #g_id_button_container {
      width: 100%;
    }

    #g_id_button_container > div {
      width: 100%;
    }

    #g_id_button_container > div > div {
      width: 100% !important;
    }

    #g_id_button_container button {
      width: 100% !important;
      padding: 16px 14px !important;
      border-radius: 12px !important;
      font-size: 16px !important;
      font-weight: 600 !important;
      height: auto !important;
      background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%) !important;
      color: #333 !important;
      border: 2px solid #e0e0e0 !important;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
      transition: all 0.3s ease !important;
      cursor: pointer !important;
    }

    #g_id_button_container button:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4) !important;
      border-color: #667eea !important;
    }

    #g_id_button_container button:active {
      transform: translateY(0) !important;
    }

    .letter {
      text-align: center;
      margin: 10px 0;
      color: #0f0f0f;
    }
    
    
    .footer-text {
      text-align: center;
      color: white;
      margin-top: 24px;
      font-size: 13px;
      opacity: 0.9;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      font-size: 14px;
    }

    /* PWA Install Button Style */
    #installBtn {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, #f0a925 10%, #ec300f 90%);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      z-index: 9999;
      animation: bounce 2s ease-in-out infinite;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    #installBtn:hover {
      box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
    }

    @media (max-width: 768px) {
    body {
      padding: 10px;
      }
    .login-card {
      padding: 30px 15px;
    }
    h1 {
      font-size: 28px;
    }
    .mob-hide {
      display: none;
    }
    .g_id_button_container{
      margin-left: 8% !important;
      width: 70% !important;
    }
  }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <div class="logo-container">
        <img class="logo" src="/icons/logo.webp" alt="" loading="lazy">
        <h1>Vibe Event Planner'Z</h1>
        <p class="subtitle">‚ú® Welcome! Please sign in to continue</p>
      </div>
      
      <div id="errorMessage" class="error-message"></div>
      <div id="loadingIndicator" class="loading">
        <div class="spinner"></div>
        <p style="margin-top: 16px; color: #667eea;">Signing you in...</p>
      </div>
      
      <div class="features">
        <div class="feature">
          <div class="feature-icon">üìÖ</div>
          <span>Manage events effortlessly</span>
        </div>
        <div class="feature mob-hide">
          <div class="feature-icon">üîí</div>
          <span>Secure access control</span>
        </div>
        <div class="feature">
          <div class="feature-icon">üìß</div>
          <span>Real-time updates</span>
        </div>
      </div>

      <div class="google-signbtn">
        <!-- Google Sign-In Button Container -->
        <div class="g_id_button_container" id="g_id_button_container" style="width: 80%; display: flex; justify-content: center; margin-top: 16px; margin-bottom: 16px; margin-left: 20%;"></div>
      </div>

      <div class="letter" style="color: white;"><h4>OR</h4></div>
      
      <form id="manualSignIn" class="manual-login" onsubmit="event.preventDefault(); handleManualSignIn();">
        <input id="manualEmail" type="email" placeholder="Email" required />
        <input id="manualPassword" type="password" placeholder="Password" required />
        <button class="manual-signin-btn" type="submit">Sign in</button>
      </form>

      <div id="g_id_onload"
           data-client_id="717691635464-pfsk7occ0pgagqakq6u6nsevg0ocjukr.apps.googleusercontent.com"
           data-callback="handleCredentialResponse">
      </div>

    </div>
    
    <p class="footer-text">
      Need help? Contact - vibeventzz@gmail.com
    </p>
  </div>

  <!-- PWA Install Button -->
    <button id="installBtn">
        üì≤ Install App
    </button>

  <script>
    // Configuration
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyLhBp0SONqnnzDdEQZUDOp4B4O8iNr_HPqMkAaZQVHBI1TsBkhrGlwoEolvQKfLtX7/exec';

    // Google Identity state
    let isGoogleInitialized = false;
    const GOOGLE_CLIENT_ID = '717691635464-pfsk7occ0pgagqakq6u6nsevg0ocjukr.apps.googleusercontent.com';

    // Called when the library has loaded (we attach this via the script onload)
    function initGoogle() {
      try {
        if (!window.google || !google.accounts || !google.accounts.id) {
          console.warn('Google Identity Services not available yet');
          return;
        }

        if (!isGoogleInitialized) {
          google.accounts.id.initialize({
            client_id: GOOGLE_CLIENT_ID,
            callback: handleCredentialResponse
          });
          isGoogleInitialized = true;

          // Render the official Google Sign-In button (fallback for users who dismissed One Tap)
          try {
            const container = document.getElementById('g_id_button_container');
            if (container) {
              google.accounts.id.renderButton(container, {
                theme: 'outline',
                size: 'large'
              });
            }
          } catch (e) {
            console.warn('renderButton failed', e);
          }

          // Prompt One Tap on first visit and listen for dismissal so we can log reasons
          try {
            showOneTapIfFirstVisit();
          } catch (e) {
            console.warn('prompt (first-visit) failed', e);
          }
        }
      } catch (e) {
        console.warn('initGoogle error:', e);
      }
    }

    // Google Sign-In Callback
    function handleCredentialResponse(response) {
      showLoading(true);

      try {
        // Decode JWT token to get user info
        const userInfo = parseJwt(response.credential);
        const userEmail = userInfo.email;

        // Store authentication
        localStorage.setItem('userEmail', userEmail);
        localStorage.setItem('isAuthenticated', 'true');
        localStorage.setItem('googleToken', response.credential);

        // Store user email in backend (Users sheet) - asynchronous, non-critical
        try {
          const params = new URLSearchParams();
          params.append('action', 'storeUserEmail');
          params.append('userEmail', userEmail);
          fetch(`${SCRIPT_URL}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
          })
            .then(r => r.json())
            .then(data => console.log('[Login] User email stored:', data))
            .catch(err => console.warn('[Login] Failed to store user email:', err));
        } catch (storageErr) {
          console.warn('[Login] User email storage error (non-critical):', storageErr);
        }

        // Check admin status
        checkAdminStatus(userEmail);
      } catch (err) {
        console.error('handleCredentialResponse error', err);
        showError('Sign-in failed. Please try again.');
      }
    }

    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        return {};
      }
    }

    async function checkAdminStatus(email) {
      try {
        // TIER 1: Check if email is in ADMIN_OVERRIDE_EMAILS (owner)
        const ADMIN_OVERRIDE_EMAILS = ['samplemail333555@gmail.com','hn6160324@gmail.com'];
        const emailLower = (email || '').toLowerCase();
        const adminOverridesLower = ADMIN_OVERRIDE_EMAILS.map(e => (e || '').toLowerCase());
        const isOwnerOverride = adminOverridesLower.indexOf(emailLower) !== -1;
        
        if (isOwnerOverride) {
          console.log('‚úÖ User is in ADMIN_OVERRIDE_EMAILS (TIER 1 - Owner)');
          localStorage.setItem('isAdmin', 'true');
          window.location.href = '/calendar.html';
          return;
        }
        
        // TIER 2: Check if email is in Admins sheet (sheet admin)
        const response = await fetch(`${SCRIPT_URL}?action=checkAdmin&email=${encodeURIComponent(email)}`);
        const data = await response.json();

        localStorage.setItem('isAdmin', data.isAdmin ? 'true' : 'false');

        // Redirect to calendar
        window.location.href = '/calendar.html';
      } catch (error) {
        console.error('Error checking admin status:', error);
        showError('Failed to verify admin status. Continuing as regular user...');
        localStorage.setItem('isAdmin', 'false');
        setTimeout(() => {
          window.location.href = '/calendar.html';
        }, 2000);
      }
    }

    // Show One Tap prompt only once per user (first visit)
    function showOneTapIfFirstVisit() {
      try {
        if (localStorage.getItem('oneTapShown') === 'true') return;

        google.accounts.id.prompt((notification) => {
          if (notification.isNotDisplayed && notification.isNotDisplayed()) {
            console.warn('One Tap not displayed:', notification.getNotDisplayedReason && notification.getNotDisplayedReason());
          }
          if (notification.isDismissedMoment && notification.isDismissedMoment()) {
            console.warn('One Tap dismissed:', notification.getDismissedReason && notification.getDismissedReason());
          }
          if (notification.isSkippedMoment && notification.isSkippedMoment()) {
            console.warn('One Tap skipped:', notification.getSkippedReason && notification.getSkippedReason());
          }
        });

        localStorage.setItem('oneTapShown', 'true');
      } catch (e) {
        console.warn('showOneTapIfFirstVisit error', e);
      }
    }

    // Trigger sign-in prompt; ensure library is ready first
    async function handleGoogleSignIn() {
      showLoading(true);

      // Wait for the Google library to become available (short timeout)
      const waitForGoogle = () => new Promise(resolve => {
        let attempts = 0;
        const iv = setInterval(() => {
          attempts++;
          if (window.google && google.accounts && google.accounts.id) {
            clearInterval(iv);
            resolve(true);
          } else if (attempts > 30) { // ~3 seconds
            clearInterval(iv);
            resolve(false);
          }
        }, 100);
      });

      const ready = await waitForGoogle();
      showLoading(false);
      if (!ready) {
        return showError('Google Sign-In failed to load. Check your network and try again.');
      }

      if (!isGoogleInitialized) initGoogle();

      try {
        google.accounts.id.prompt();
      } catch (e) {
        console.warn('prompt failed, attempting a fallback render:', e);
        try {
          // As a fallback, try a direct initialize + prompt
          initGoogle();
          google.accounts.id.prompt();
        } catch (err) {
          console.error('Sign-in fallback failed:', err);
          showError('Unable to start Google Sign-In.');
        }
      }
    }

    // ==================== MANUAL LOGIN HANDLER ====================
    async function handleManualSignIn() {
      showLoading(true);
      
      try {
        const email = document.getElementById('manualEmail').value.trim();
        const password = document.getElementById('manualPassword').value;
        
        if (!email || !password) {
          showError('Email and password are required');
          showLoading(false);
          return;
        }
        
        console.log('Validating manual login for:', email);
        console.log('SCRIPT_URL:', SCRIPT_URL);
        
        // Call backend to validate credentials against Manual-Login sheet
        const url = SCRIPT_URL + '?action=validateManualLogin&email=' + encodeURIComponent(email) + '&password=' + encodeURIComponent(password);
        console.log('Fetch URL:', url);
        
        const response = await fetch(url);
        console.log('Response status:', response.status, response.statusText);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('Validation result:', result);
        
        if (result.success) {
          console.log('‚úÖ Manual login successful!');
          localStorage.setItem('userEmail', email);
          localStorage.setItem('isAuthenticated', 'true');
          localStorage.setItem('loginMethod', 'manual');
          
          // Store user email in backend
          try {
            await fetch(SCRIPT_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                action: 'storeUserEmail',
                userEmail: email
              })
            });
          } catch (e) {
            console.log('Could not store user email:', e);
          }
          
          // Check admin status before redirecting
          console.log('Checking admin status for:', email);
          checkAdminStatus(email);
        } else {
          console.error('‚ùå Login failed:', result.message);
          showError(result.message || 'Invalid email or password');
          showLoading(false);
        }
        
      } catch (error) {
        console.error('Manual login error:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          name: error.name
        });
        showError('Login failed: ' + error.message);
        showLoading(false);
      }
    }

    function showLoading(show) {
      document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      showLoading(false);
    }

    // Check if already authenticated
    window.onload = function() {
      const isAuthenticated = localStorage.getItem('isAuthenticated');
      if (isAuthenticated === 'true') {
        window.location.href = '/calendar.html';
        return;
      }

      // Attempt to init if library already loaded
      try { initGoogle(); } catch (e) { /* handled in initGoogle */ }
    };
  </script>
  
  <!-- PWA Scripts -->
  <script src="/sw-register.js"></script>
</body>
</html>